<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü—Ä–æ–≤–µ—Ä–∫–∞ —á–∏—Å—Ç–æ—Ç—ã —á–∞—Ç–∞ JARVIS</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.6; }
        .test-result { margin: 15px 0; padding: 15px; border-radius: 8px; }
        .success { background: #d4edda; border: 2px solid #28a745; }
        .error { background: #f8d7da; border: 2px solid #dc3545; }
        .info { background: #d1ecf1; border: 2px solid #17a2b8; }
        button { padding: 12px 24px; margin: 10px 5px; font-size: 16px; cursor: pointer; }
        .symbols-to-check { background: #fff3cd; padding: 10px; margin: 10px 0; border-radius: 5px; }
    </style>
</head>
<body>
    <h1>üîç –ü—Ä–æÔøΩÔøΩ–µ—Ä–∫–∞ JARVIS –Ω–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —Å–∏–º–≤–æ–ª–æ–≤</h1>
    
    <div class="symbols-to-check">
        <strong>–ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —Å–∏–º–≤–æ–ª–æ–≤:</strong> ‚Ä¢ ‚óè ‚óã ‚ñ† ‚ñ° ‚òÖ ‚òÜ ‚Üí ‚Üê ‚Üë ‚Üì ‚úì ‚úó ‚ñ∫ ‚óÑ ‚ñ≤ ‚ñº # * ** ``` _ ~ | > < -
    </div>
    
    <button onclick="testChatInterface()">üîç –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å</button>
    <button onclick="testChatAPI()">üí¨ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å API –æ—Ç–≤–µ—Ç—ã</button>
    
    <div id="results"></div>

    <script>
        const symbolsToFind = ['‚Ä¢', '‚óè', '‚óã', '‚ñ†', '‚ñ°', '‚òÖ', '‚òÜ', '‚Üí', '‚Üê', '‚Üë', '‚Üì', '‚úì', '‚úó', '‚ñ∫', '‚óÑ', '‚ñ≤', '‚ñº', '#', '**', '```', '_', '~', '|', '<', '>', '-'];
        
        function findSymbolsInText(text) {
            const found = [];
            symbolsToFind.forEach(symbol => {
                if (text.includes(symbol)) {
                    found.push(symbol);
                }
            });
            return found;
        }
        
        async function testChatInterface() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<div class="info test-result">üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —á–∞—Ç–∞...</div>';
            
            try {
                // –ü–æ–ª—É—á–∞–µ–º –≥–ª–∞–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
                const response = await fetch('/');
                const html = await response.text();
                
                // –ò—â–µ–º —Å–∏–º–≤–æ–ª—ã –≤ HTML
                const foundSymbols = findSymbolsInText(html);
                
                let resultHtml = '';
                if (foundSymbols.length === 0) {
                    resultHtml = `<div class="success test-result">
                        ‚úÖ <strong>–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å —á–∏—Å—Ç—ã–π!</strong><br>
                        –ù–∏–∫–∞–∫–∏—Ö –∑–∞–ø—Ä–µ—â–µ–Ω–Ω—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –≤ HTML –∫–æ–¥–µ.
                    </div>`;
                } else {
                    resultHtml = `<div class="error test-result">
                        ‚ùå <strong>–ù–∞–π–¥–µ–Ω—ã —Å–∏–º–≤–æ–ª—ã –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ:</strong><br>
                        ${foundSymbols.join(', ')}<br>
                        <small>–¢—Ä–µ–±—É–µ—Ç—Å—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞</small>
                    </div>`;
                }
                
                resultsDiv.innerHTML = resultHtml;
                
            } catch (error) {
                resultsDiv.innerHTML = `<div class="error test-result">
                    ‚ùå <strong>–û—à–∏–±–∫–∞ –ø—ÄÔøΩÔøΩ–≤–µ—Ä–∫–∏:</strong><br>
                    ${error.message}
                </div>`;
            }
        }
        
        async function testChatAPI() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<div class="info test-result">üí¨ –¢–µ—Å—Ç–∏—Ä—É–µ–º API –æ—Ç–≤–µ—Ç—ã...</div>';
            
            const testMessages = [
                '–ø—Ä–∏–≤–µ—Ç',
                '—á—Ç–æ —É–º–µ–µ—à—å',
                '–∫–∞–∫ –¥–µ–ª–∞',
                '–æ–±—ä—è—Å–Ω–∏ —á—Ç–æ —Ç–∞–∫–æ–µ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ'
            ];
            
            let allClean = true;
            let results = '';
            
            for (const message of testMessages) {
                try {
                    const response = await fetch('/api/chat', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            messages: [{ role: 'user', content: message }]
                        })
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        const foundSymbols = findSymbolsInText(data.message);
                        
                        if (foundSymbols.length > 0) {
                            allClean = false;
                            results += `<div class="error test-result">
                                ‚ùå <strong>–ó–∞–ø—Ä–æ—Å:</strong> "${message}"<br>
                                <strong>–ù–∞–π–¥–µ–Ω–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã:</strong> ${foundSymbols.join(', ')}<br>
                                <strong>–û—Ç–≤–µ—Ç:</strong> ${data.message.substring(0, 100)}...
                            </div>`;
                        } else {
                            results += `<div class="success test-result">
                                ‚úÖ <strong>–ó–∞–ø—Ä–æ—Å:</strong> "${message}"<br>
                                <strong>–û—Ç–≤–µ—Ç —á–∏—Å—Ç—ã–π!</strong> –ù–∏–∫–∞–∫–∏—Ö —Å–∏–º–≤–æ–ª–æ–≤ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.
                            </div>`;
                        }
                    } else {
                        results += `<div class="error test-result">
                            ‚ùå <strong>–û—à–∏–±–∫–∞ API –¥–ª—è:</strong> "${message}"<br>
                            Status: ${response.status}
                        </div>`;
                    }
                    
                    // –ü–∞—É–∑–∞ –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    
                } catch (error) {
                    results += `<div class="error test-result">
                        ‚ùå <strong>–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –¥–ª—è:</strong> "${message}"<br>
                        ${error.message}
                    </div>`;
                }
            }
            
            if (allClean) {
                results = `<div class="success test-result">
                    üéâ <strong>–í–°–ï –¢–ï–°–¢–´ –ü–†–û–®–õ–ò!</strong><br>
                    –í—Å–µ API –æ—Ç–≤–µ—Ç—ã –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ—á–∏—â–µ–Ω—ã –æ—Ç —Å–∏–º–≤–æ–ª–æ–≤ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.
                </div>` + results;
            }
            
            resultsDiv.innerHTML = results;
        }
    </script>
</body>
</html>
